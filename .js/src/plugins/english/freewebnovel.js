var e=this&&this.__assign||function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},e.apply(this,arguments)},t=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(a,o){function l(e){try{s(n.next(e))}catch(e){o(e)}}function i(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(l,i)}s((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var r,n,a,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},l=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return l.next=i(0),l.throw=i(1),l.return=i(2),"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function i(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;l&&(l=0,i[0]&&(o=0)),o;)try{if(r=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],n=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n,a=require("@libs/fetch"),o=require("htmlparser2"),l=require("@libs/filterInputs"),i=function(){function i(){this.id="FWN.com",this.name="Free Web Novel",this.site="https://freewebnovel.com/",this.version="2.0.2",this.icon="src/en/freewebnovel/icon.png",this.lastSearch=null,this.searchInterval=3400,this.filters={genres:{type:l.FilterTypes.Picker,label:"Genre",value:"",options:[{label:"Action",value:"genre/Action/"},{label:"Adult",value:"genre/Adult/"},{label:"Adventure",value:"genre/Adventure/"},{label:"Comedy",value:"genre/Comedy/"},{label:"Drama",value:"genre/Drama/"},{label:"Eastern",value:"genre/Eastern"},{label:"Ecchi",value:"genre/Ecchi/"},{label:"Fantasy",value:"genre/Fantasy/"},{label:"Gender Bender",value:"genre/Gender+Bender/"},{label:"Harem",value:"genre/Harem/"},{label:"Historical",value:"genre/Historical/"},{label:"Horror",value:"genre/Horror/"},{label:"Josei",value:"genre/Josei/"},{label:"Game",value:"genre/Game/"},{label:"Martial Arts",value:"genre/Martial+Arts/"},{label:"Mature",value:"genre/Mature/"},{label:"Mecha",value:"genre/Mecha/"},{label:"Mystery",value:"genre/Mystery/"},{label:"Psychological",value:"genre/Psychological/"},{label:"Reincarnation",value:"genre/Reincarnation"},{label:"Romance",value:"genre/Romance/"},{label:"School Life",value:"genre/School+Life/"},{label:"Sci-fi",value:"genre/Sci-fi/"},{label:"Seinen",value:"genre/Seinen/"},{label:"Shoujo",value:"genre/Shoujo/"},{label:"Shounen Ai",value:"genre/Shounen+Ai/"},{label:"Shounen",value:"genre/Shounen/"},{label:"Slice of Life",value:"genre/Slice+of+Life/"},{label:"Smut",value:"genre/Smut/"},{label:"Sports",value:"genre/Sports/"},{label:"Supernatural",value:"genre/Supernatural/"},{label:"Tragedy",value:"genre/Tragedy/"},{label:"Wuxia",value:"genre/Wuxia/"},{label:"Xianxia",value:"genre/Xianxia/"},{label:"Xuanhuan",value:"genre/Xuanhuan/"},{label:"Yaoi",value:"genre/Yaoi/"}]}}}return i.prototype.sleep=function(e){return t(this,void 0,void 0,(function(){return r(this,(function(t){return[2,new Promise((function(t){return setTimeout(t,e)}))]}))}))},i.prototype.getHtml=function(e){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return[4,(0,a.fetchApi)(e)];case 1:if(!(t=r.sent()).ok)throw new Error("Could not reach site (".concat(t.status,": ").concat(t.statusText,") try to open in webview."));return[4,t.text()];case 2:return[2,r.sent()]}}))}))},i.prototype.parseNovels=function(t){var r=this.site,a=[],l={},i=n.Idle,s=new o.Parser({onopentag:function(e,t){var a;if("li-row"===t.class&&(i=n.Novel),i===n.Novel)switch(e){case"a":l.path=null===(a=t.href)||void 0===a?void 0:a.split("/").slice(1,3).join("/");break;case"img":var o=t.src||"";l.name=t.title,l.cover=o.startsWith("http")?o:r+o}},onclosetag:function(t){"div"===t&&(l.name&&l.path&&a.push(e({},l)),l={},i=n.Idle)}});return s.write(t),s.end(),a},i.prototype.popularNovels=function(e,n){return t(this,arguments,void 0,(function(e,t){var n,a,o,l,i=t.showLatestNovels,s=t.filters;return r(this,(function(t){switch(t.label){case 0:if(i)n="sort/latest-novels/";else if(null===(l=null==s?void 0:s.genres)||void 0===l?void 0:l.value)n=s.genres.value;else{if(1!==e)return[2,[]];n="most-popular/",e=0}return a="".concat(this.site).concat(n).concat(e),[4,this.getHtml(a)];case 1:return o=t.sent(),[2,this.parseNovels(o)]}}))}))},i.prototype.parseNovel=function(a){return t(this,void 0,void 0,(function(){var t,l,i,s,u,c,h,p,v,f,b,d;return r(this,(function(r){switch(r.label){case 0:return t=this.site,[4,this.getHtml(this.site+a)];case 1:return l=r.sent(),i={path:a},s=0,u=n.Idle,c={},h=[],p=[],v=[],f=[],b=[],d=new o.Parser({onopentag:function(e,r){var o;switch(e){case"div":switch(r.class){case"m-imgtxt":u=n.NovelInfo;break;case"inner":u=n.Summary;break;case"m-desc":u=n.Idle}break;case"img":u===n.NovelInfo&&(i.name=r.title,i.cover=t+r.src);break;case"span":if(u===n.NovelInfo&&r.title){var l={Genre:n.Genre,Author:n.Author,Status:n.Status};u=null!==(o=l[r.title])&&void 0!==o?o:u}break;case"ul":"idData"===r.id&&(u=n.ChapterList);break;case"a":if(u===n.ChapterList){s++;var h=r.href;u=n.Chapter,c.name=r.title||"Chapter ".concat(s),c.releaseTime=null,c.chapterNumber=s,c.path=(null==h?void 0:h.slice(1))||a.replace(".html","/chapter-".concat(s,".html"))}break;default:return}},ontext:function(e){switch(u){case n.Genre:b.push(e);break;case n.Author:f.push(e);break;case n.Status:v.push(e.trim());break;case n.Summary:p.push(e.trim());break;default:return}},onclosetag:function(t){switch(t){case"div":switch(u){case n.Genre:case n.Author:case n.Status:u=n.NovelInfo;break;case n.Summary:u=n.Idle}case"a":u===n.Chapter&&(c.name&&c.path&&h.push(e({},c)),c={},u=n.ChapterList);break;case"ul":u===n.ChapterList&&(u=n.Idle);break;default:return}},onend:function(){i.chapters=h,i.genres=b.join("").trim(),i.author=f.join("").trim(),i.summary=p.join("\n\n"),i.status=v.join("").toLowerCase().replace(/\b\w/g,(function(e){return e.toUpperCase()}))}}),d.write(l),d.end(),[2,i]}}))}))},i.prototype.parseChapter=function(e){return t(this,void 0,void 0,(function(){var t,a,l,i,s,u,c,h,p,v,f,b,d;return r(this,(function(r){switch(r.label){case 0:return[4,this.getHtml(this.site+e)];case 1:return t=r.sent(),a=t.match(/e\("([^]+?)"/),l=a?a[1]:"",i=l?t.replace(l,""):t,s=0,u=n.Idle,c=[],h=!1,p="",v=/[&<>"' ]/g,f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"," ":"&nbsp;"},b=function(e){return e.replace(v,(function(e){return f[e]}))},d=new o.Parser({onopentag:function(e,t){var r,a=null===(r=t.class)||void 0===r?void 0:r.trim();switch(u){case n.Idle:"txt"===a&&(u=n.Chapter,s++);break;case n.Chapter:"div"===e&&s++;break;default:return}if(u===n.Chapter){var o=Object.keys(t);if(0===o.length)c.push("<".concat(e,">"));else if(o.every((function(e){return""===t[e].trim()}))){h=!0,p=e;var l=e.replace(/\b\w/g,(function(e){return e.toUpperCase()}));c.push(b("<".concat(l," ").concat(o.join(" "),">")))}else{var i=o.map((function(e){return" ".concat(e,'="').concat(t[e].replace(/"/g,"&quot;"),'"')})).join("");c.push("<".concat(e).concat(i,">"))}}},ontext:function(e){u===n.Chapter&&c.push(b(e))},onclosetag:function(e){u===n.Chapter&&(d.isVoidElement(e)||(h&&e===p?(h=!1,p=""):c.push("</".concat(e,">"))),"div"===e&&s--,0===s&&(u=n.Stopped))}}),d.write(i),d.end(),[2,c.join("")]}}))}))},i.prototype.searchNovels=function(e){return t(this,void 0,void 0,(function(){var t,n,o,l,i;return r(this,(function(r){switch(r.label){case 0:return t=Date.now(),this.lastSearch&&t-this.lastSearch<=this.searchInterval?[4,this.sleep(this.searchInterval)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[4,(0,a.fetchApi)(this.site+"search",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({searchkey:e}).toString()})];case 3:if(n=r.sent(),this.lastSearch=Date.now(),!n.ok)throw new Error("Could not reach site ('".concat(n.status,"') try to open in webview."));return[4,n.text()];case 4:if(o=r.sent(),l=(null===(i=o.match(/alert\((.*?)\)/))||void 0===i?void 0:i[1])||"")throw new Error(l);return[2,this.parseNovels(o)]}}))}))},i}();exports.default=new i,function(e){e[e.Idle=0]="Idle",e[e.Novel=1]="Novel",e[e.Genre=2]="Genre",e[e.Author=3]="Author",e[e.Status=4]="Status",e[e.Summary=5]="Summary",e[e.NovelInfo=6]="NovelInfo",e[e.ChapterList=7]="ChapterList",e[e.Chapter=8]="Chapter",e[e.Stopped=9]="Stopped"}(n||(n={}));